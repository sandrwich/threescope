<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Threescope</title>
  <link rel="icon" type="image/png" href="/textures/sat_icon.png">
  <meta name="theme-color" content="#101010">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="/textures/icon-192.png">
  <script>
    // Apply theme before first paint to prevent flash
    var t = localStorage.getItem('threescope_theme');
    if (!t) t = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'oled' : 'default';
    if (t !== 'default') document.documentElement.setAttribute('data-theme', t);
  </script>
  <style>
    @font-face {
      font-family: 'Overpass Mono';
      src: url('/textures/overpass-mono.ttf') format('truetype');
      font-weight: 400;
      font-display: swap;
    }

    :root {
      --bg: #101010;
      --ui-bg: #1a1a1a;
      --border: #555;
      --border-hover: #aaa;
      --text: #fff;
      --text-dim: #ccc;
      --text-muted: #999;
      --text-faint: #777;
      --text-ghost: #555;
      --card-bg: rgba(0,0,0,0.85);
      --modal-bg: #1a1a1a;
      --modal-overlay: rgba(0,0,0,0.7);
      --kbd-bg: #333;
      --link: #666;
      --link-hover: #aaa;
      --attrib: #555;
    }
    [data-theme="oled"] {
      --bg: #000000;
      --ui-bg: #0a0a0a;
      --border: #333;
      --border-hover: #666;
      --text: #ddd;
      --text-dim: #aaa;
      --text-muted: #777;
      --text-faint: #555;
      --text-ghost: #333;
      --card-bg: rgba(0,0,0,0.95);
      --modal-bg: #0a0a0a;
      --modal-overlay: rgba(0,0,0,0.85);
      --kbd-bg: #1a1a1a;
      --link: #444;
      --link-hover: #888;
      --attrib: #333;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      width: 100%; height: 100%; overflow: hidden;
      background: var(--bg);
      font-family: 'Overpass Mono', 'Courier New', monospace;
      color: var(--text);
      overscroll-behavior: none; touch-action: none;
    }
    canvas { display: block; }

    #ui-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none; user-select: none;
    }
    #ui-overlay > * { pointer-events: auto; }

    /* Loading screen */
    #loading-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      background: var(--bg); z-index: 1000;
    }
    #loading-screen .bar-outer { width: 400px; height: 30px; border: 2px solid var(--text); }
    #loading-screen .bar-inner {
      height: 100%; width: 0%; background: var(--text-dim); transition: width 0.3s;
      margin: 4px; height: calc(100% - 8px);
    }
    #loading-screen .msg { margin-bottom: 16px; font-size: 18px; color: var(--text); }

    /* Top-left panel: status line + toggles */
    #top-panel {
      position: absolute; top: 8px; left: 10px;
      display: flex; flex-direction: column; gap: 4px;
    }
    #status-line {
      font-size: 13px; color: var(--text-muted); white-space: nowrap;
    }

    /* Stats (top-right) */
    #stats-panel {
      position: absolute; top: 8px; right: 10px;
      text-align: right;
    }
    #stats-panel .fps { color: #00ff00; font-size: 14px; font-weight: bold; }
    #stats-panel .sat-count { color: var(--text-muted); font-size: 12px; margin-top: 1px; }

    #toggle-row {
      display: flex; align-items: center; gap: 10px;
    }
    #toggle-row label {
      display: flex; align-items: center; gap: 6px;
      font-size: 13px; cursor: pointer; color: var(--text-dim);
      line-height: 20px;
    }
    #toggle-row label:hover { color: var(--text); }
    #toggle-row input[type="checkbox"] {
      appearance: none; -webkit-appearance: none;
      width: 16px; height: 16px;
      border: 2px solid var(--border-hover); background: transparent;
      cursor: pointer; position: relative; flex-shrink: 0;
    }
    #toggle-row input[type="checkbox"]:hover { border-color: var(--text); }
    #toggle-row input[type="checkbox"]:checked::after {
      content: '';
      position: absolute;
      top: 2px; left: 2px; right: 2px; bottom: 2px;
      background: var(--text);
    }

    /* Help button */
    #info-btn, #settings-btn {
      background: var(--ui-bg); border: 1px solid var(--border);
      color: var(--text-faint); font-size: 13px; font-family: inherit;
      padding: 3px 8px; cursor: pointer;
    }
    #info-btn:hover, #settings-btn:hover { border-color: var(--border-hover); color: var(--text-dim); }

    /* TLE Picker (bottom-right) */
    #tle-picker {
      position: absolute; bottom: 10px; right: 10px;
      display: flex; flex-direction: column; align-items: flex-end; gap: 6px;
    }
    #tle-main-row {
      display: flex; align-items: center; gap: 6px;
    }
    #tle-picker select, #tle-picker button, #tle-picker input[type="text"] {
      background: var(--ui-bg); color: var(--text); border: 1px solid var(--border);
      padding: 3px 6px; font-size: 13px; font-family: inherit;
      cursor: pointer;
    }
    #tle-picker select:hover, #tle-picker button:hover, #tle-picker input[type="text"]:hover {
      border-color: var(--border-hover);
    }
    #tle-custom-row { display: none; gap: 4px; align-items: center; }
    #tle-custom-row.visible { display: flex; }
    #tle-url-input { width: 220px; cursor: text; }
    #tle-url-input::placeholder { color: var(--text-ghost); }
    #tle-file-input {
      position: absolute; width: 0; height: 0; overflow: hidden;
      opacity: 0; pointer-events: none;
    }

    /* Satellite info tooltip */
    #sat-info {
      position: absolute; display: none;
      background: var(--card-bg); padding: 8px 12px;
      font-size: 13px; line-height: 1.4;
      min-width: 200px; pointer-events: none;
      border-left: 2px solid var(--border); z-index: 10;
    }
    #sat-info .sat-name { font-size: 14px; margin-bottom: 4px; }
    #sat-info .sat-detail { color: var(--text-dim); }

    /* Apsis labels */
    .apsis-label {
      position: absolute; display: none; font-size: 12px;
      pointer-events: none; white-space: nowrap;
    }
    .apsis-label.peri { color: #87ceeb; }
    .apsis-label.apo { color: #ffa500; }

    /* Bottom-left: attribution */
    #bottom-panel {
      position: absolute; bottom: 8px; left: 10px;
      font-size: 11px; line-height: 1.4; color: var(--attrib);
    }
    #bottom-panel a { color: var(--link); text-decoration: none; pointer-events: auto; }
    #bottom-panel a:hover { color: var(--link-hover); }

    /* Info modal */
    #info-modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      z-index: 999; align-items: center; justify-content: center;
      background: var(--modal-overlay);
    }
    #info-modal.visible { display: flex; }
    #info-modal-content {
      background: var(--modal-bg); border: 1px solid var(--border);
      padding: 18px 22px; max-width: 420px; width: 90%;
      font-size: 13px; line-height: 1.6; color: var(--text-muted);
    }
    #info-modal-content h3 {
      font-size: 14px; color: var(--text-dim); margin-bottom: 8px; font-weight: normal;
    }
    #info-modal-content h4 {
      font-size: 12px; color: var(--link); margin-bottom: 4px; font-weight: normal;
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    #info-modal-content .section { margin-bottom: 14px; }
    #info-modal-content .section:last-child { margin-bottom: 0; }
    #info-modal-content .ctrl-table {
      display: grid; grid-template-columns: auto 1fr; gap: 2px 12px;
    }
    #info-modal-content .ctrl-key { color: var(--text-dim); text-align: right; white-space: nowrap; }
    #info-modal-content .ctrl-desc { color: var(--text-muted); }
    #info-modal-content a { color: var(--text-faint); text-decoration: none; }
    #info-modal-content a:hover { color: var(--text-dim); }
    #info-modal-content kbd {
      background: var(--kbd-bg); border: 1px solid var(--border); padding: 0 4px;
      font-family: inherit; font-size: 12px; color: var(--text-dim);
    }
    .touch-controls { display: none; margin-bottom: 14px; }
    .desktop-controls { display: block; margin-bottom: 14px; }
    @media (pointer: coarse) {
      .touch-controls { display: block; }
      .desktop-controls { display: none; }
    }
    #info-modal-close {
      background: transparent; border: 1px solid var(--border);
      color: var(--text-muted); font-size: 13px; font-family: inherit;
      padding: 4px 14px; cursor: pointer; margin-top: 10px;
      float: right;
    }
    #info-modal-close:hover { border-color: var(--border-hover); color: var(--text-dim); }

    /* Settings modal */
    #settings-modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      z-index: 999; align-items: center; justify-content: center;
      background: var(--modal-overlay);
    }
    #settings-modal.visible { display: flex; }
    #settings-modal-content {
      background: var(--modal-bg); border: 1px solid var(--border);
      padding: 18px 22px; max-width: 320px; width: 90%;
      font-size: 13px; line-height: 1.6; color: var(--text-muted);
    }
    #settings-modal-content h3 {
      font-size: 14px; color: var(--text-dim); margin-bottom: 12px; font-weight: normal;
    }
    .settings-row {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 10px;
    }
    .settings-row label { color: var(--text-dim); }
    .settings-row select {
      background: var(--ui-bg); color: var(--text); border: 1px solid var(--border);
      padding: 3px 6px; font-size: 13px; font-family: inherit; cursor: pointer;
    }
    .settings-row select:hover { border-color: var(--border-hover); }
    .settings-checkbox {
      appearance: none; -webkit-appearance: none;
      width: 16px; height: 16px;
      border: 2px solid var(--border-hover); background: transparent;
      cursor: pointer; position: relative;
    }
    .settings-checkbox:hover { border-color: var(--text); }
    .settings-checkbox:checked::after {
      content: ''; position: absolute;
      top: 2px; left: 2px; right: 2px; bottom: 2px;
      background: var(--text);
    }
    #settings-modal-close {
      background: transparent; border: 1px solid var(--border);
      color: var(--text-muted); font-size: 13px; font-family: inherit;
      padding: 4px 14px; cursor: pointer; margin-top: 6px;
      float: right;
    }
    #settings-modal-close:hover { border-color: var(--border-hover); color: var(--text-dim); }

    /* Mobile */
    @media (max-width: 600px) {
      #status-line { font-size: 11px; }
      #toggle-row label { font-size: 12px; }
      #toggle-row input[type="checkbox"] { width: 22px; height: 22px; }
      #toggle-row { gap: 10px; }
      #sat-info { font-size: 12px; min-width: 170px; }
      #sat-info .sat-name { font-size: 13px; }
      #tle-picker select, #tle-picker button, #tle-picker input[type="text"] {
        font-size: 13px; padding: 5px 8px;
      }
      #tle-url-input { width: 130px; }
      #tle-custom-row { flex-wrap: wrap; justify-content: flex-end; }
      #bottom-panel { display: none; }
      #info-btn {
        position: fixed; bottom: 10px; left: 10px;
        padding: 5px 10px; font-size: 15px;
      }
      #loading-screen .bar-outer { width: 80%; max-width: 280px; height: 22px; }
      #loading-screen .msg { font-size: 15px; }
    }
  </style>
</head>
<body>
  <div id="loading-screen">
    <div class="msg" id="loading-msg">Initializing...</div>
    <div class="bar-outer"><div class="bar-inner" id="loading-bar"></div></div>
  </div>

  <div id="info-modal">
    <div id="info-modal-content">
      <div class="touch-controls">
        <div class="section">
          <h3>Touch</h3>
          <div class="ctrl-table">
            <span class="ctrl-key">1 finger drag</span><span class="ctrl-desc">Orbit camera</span>
            <span class="ctrl-key">2 finger drag</span><span class="ctrl-desc">Pan camera</span>
            <span class="ctrl-key">Pinch</span><span class="ctrl-desc">Zoom in / out</span>
            <span class="ctrl-key">Tap satellite</span><span class="ctrl-desc">Select / deselect</span>
          </div>
        </div>
      </div>
      <div class="desktop-controls">
        <div class="section">
          <h3>Mouse</h3>
          <div class="ctrl-table">
            <span class="ctrl-key"><kbd>RMB</kbd> drag</span><span class="ctrl-desc">Orbit camera</span>
            <span class="ctrl-key"><kbd>Shift</kbd>+<kbd>RMB</kbd> drag</span><span class="ctrl-desc">Pan camera</span>
            <span class="ctrl-key"><kbd>Scroll</kbd></span><span class="ctrl-desc">Zoom in / out</span>
            <span class="ctrl-key">Click satellite</span><span class="ctrl-desc">Select / deselect</span>
          </div>
        </div>
        <div class="section">
          <h3>Keyboard</h3>
          <div class="ctrl-table">
            <span class="ctrl-key"><kbd>Space</kbd></span><span class="ctrl-desc">Pause / resume</span>
            <span class="ctrl-key"><kbd>.</kbd> <kbd>,</kbd></span><span class="ctrl-desc">Speed up / slow down</span>
            <span class="ctrl-key"><kbd>/</kbd></span><span class="ctrl-desc">Reset speed</span>
            <span class="ctrl-key"><kbd>M</kbd></span><span class="ctrl-desc">Toggle 2D / 3D map</span>
          </div>
        </div>
      </div>
      <div class="section">
        <h3>About</h3>
        TLE data from <a href="https://celestrak.org" target="_blank">CelesTrak</a><br>
        Based on <a href="https://github.com/aweeri/TLEscope" target="_blank">TLEscope</a> by aweeri<br>
        <a href="https://github.com/aweeri/TLEscope/blob/main/LICENSE" target="_blank">AGPL-3.0</a>
        &middot; <a href="https://github.com/sandrwich/threescope" target="_blank">Source code</a>
      </div>
      <button id="info-modal-close">Close</button>
    </div>
  </div>

  <div id="settings-modal">
    <div id="settings-modal-content">
      <h3>Settings</h3>
      <div class="settings-row">
        <label>Theme</label>
        <select id="theme-select">
          <option value="default">Default</option>
          <option value="oled">OLED</option>
        </select>
      </div>
      <div class="settings-row">
        <label>Unlock FPS</label>
        <input type="checkbox" id="cb-unlock-fps" class="settings-checkbox">
      </div>
      <button id="settings-modal-close">Close</button>
    </div>
  </div>

  <div id="ui-overlay">
    <div id="top-panel">
      <div id="status-line"></div>
      <div id="toggle-row">
        <label title="Hide all satellites except selected"><input type="checkbox" id="cb-hide-unselected"> Spotlight</label>
        <label title="Show cloud layer on Earth"><input type="checkbox" id="cb-clouds"> Clouds</label>
        <label title="Show city lights on night side"><input type="checkbox" id="cb-night-lights" checked> Night</label>
      </div>
    </div>
    <div id="stats-panel">
      <div class="fps" id="fps-display">-- FPS</div>
      <div class="sat-count" id="sat-count-display"></div>
    </div>
    <div id="tle-picker">
      <div id="tle-main-row">
        <button id="settings-btn" title="Settings">&#9881;</button>
        <button id="info-btn">?</button>
        <select id="tle-select"></select>
      </div>
      <div id="tle-custom-row">
        <input type="text" id="tle-url-input" placeholder="TLE URL...">
        <button id="tle-url-btn">Load</button>
        <button id="tle-file-btn">File</button>
        <input type="file" id="tle-file-input" accept=".tle,.txt,.3le">
      </div>
    </div>
    <div id="sat-info">
      <div class="sat-name" id="sat-info-name"></div>
      <div class="sat-detail" id="sat-info-detail"></div>
    </div>
    <div class="apsis-label peri" id="peri-label"></div>
    <div class="apsis-label apo" id="apo-label"></div>
    <div id="bottom-panel">
      <div>
        TLE data from <a href="https://celestrak.org" target="_blank">CelesTrak</a><br>
        Based on <a href="https://github.com/aweeri/TLEscope" target="_blank">TLEscope</a> by aweeri
        &middot; <a href="https://github.com/aweeri/TLEscope/blob/main/LICENSE" target="_blank">AGPL-3.0</a>
        &middot; <a href="https://github.com/sandrwich/threescope" target="_blank">Source code</a>
      </div>
    </div>
  </div>

  <script type="module" src="/src/main.ts"></script>
</body>
</html>
